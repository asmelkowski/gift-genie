import { test, expect } from '@playwright/test';
import { AdminDashboardPage } from '../page-objects/AdminDashboardPage';
import { AppLayoutPage } from '../page-objects/AppLayoutPage';
import { createAdminUser, createRegularUser } from '../helpers';

test.describe('Admin Dashboard Access Control', () => {
  /**
   * Test 1: Admin user can access the admin dashboard
   *
   * Verifies that an authenticated admin user can successfully navigate to
   * and view the admin dashboard page with all expected elements visible.
   */
  test('admin user can access dashboard', async ({ page, context }) => {
    // Create and login admin user
    console.log('[E2E] Test: Admin user can access dashboard');
    const adminUser = await createAdminUser(page, context);

    const adminDashboard = new AdminDashboardPage(page);

    // Navigate to admin dashboard
    await adminDashboard.goto();

    // Wait for dashboard to load completely
    await adminDashboard.waitForLoad();

    // Verify dashboard is visible
    await adminDashboard.expectPageVisible();

    // Verify key dashboard elements are present
    await adminDashboard.expectSearchInputVisible();
    await adminDashboard.expectUserTableVisible();

    console.log('[E2E] ✓ Admin user successfully accessed dashboard');
  });

  /**
   * Test 2: Admin user sees user list and groups tabs
   *
   * Verifies that an admin user can see the primary dashboard elements
   * (users table, search, pagination) after logging in.
   */
  test('admin user sees user list and groups tabs', async ({ page, context }) => {
    // Create and login admin user
    console.log('[E2E] Test: Admin user sees user list and groups tabs');
    const adminUser = await createAdminUser(page, context);

    const adminDashboard = new AdminDashboardPage(page);

    // Navigate to admin dashboard
    await adminDashboard.goto();

    // Wait for dashboard to load
    await adminDashboard.waitForLoad();

    // Verify users tab (search input and table) is visible
    await adminDashboard.expectSearchInputVisible();
    await expect(page.getByTestId('user-search-input')).toHaveAttribute('placeholder', /search/i);

    // Verify user table is visible
    await adminDashboard.expectUserTableVisible();

    // Verify we can see pagination or at least some indication of user list
    const userRows = page.getByTestId(/^user-row-/);
    const rowCount = await userRows.count();
    expect(rowCount).toBeGreaterThanOrEqual(0);

    console.log(`[E2E] ✓ Admin sees users list with ${rowCount} visible users`);
  });

  /**
   * Test 3: Regular (non-admin) user cannot access the admin dashboard
   *
   * Verifies that when a regular user attempts to navigate to /app/admin,
   * they cannot access it (either redirected or get access denied).
   */
  test('regular user cannot access dashboard', async ({ page, context }) => {
    // Create and login regular (non-admin) user
    console.log('[E2E] Test: Regular user cannot access dashboard');
    const regularUser = await createRegularUser(page, context);

    const adminDashboard = new AdminDashboardPage(page);

    // Attempt to navigate to admin dashboard
    console.log('[E2E] Attempting to navigate to /app/admin as regular user...');
    await page.goto('/app/admin');

    // Verify we cannot access the dashboard
    // Either we get a 403 error, access denied message, or redirect to /app/groups
    const url = page.url();
    const isDashboardAccessible = await page
      .getByTestId('admin-dashboard')
      .isVisible()
      .catch(() => false);

    // Verify either:
    // 1. We were redirected away from /admin
    // 2. Dashboard is not visible (access denied)
    const wasRedirected = !url.includes('/admin');
    const dashboardNotVisible = !isDashboardAccessible;

    if (!wasRedirected && !dashboardNotVisible) {
      throw new Error(`Regular user was able to access admin dashboard! URL: ${url}`);
    }

    console.log(
      `[E2E] ✓ Regular user access denied (redirected: ${wasRedirected}, dashboard hidden: ${dashboardNotVisible})`
    );
  });

  /**
   * Test 4: Regular user does not see Admin link in navigation
   *
   * Verifies that the navigation menu does not display an "Admin" or
   * "Admin Dashboard" link to regular (non-admin) users.
   */
  test('regular user does not see Admin link in navigation', async ({ page, context }) => {
    // Create and login regular user
    console.log('[E2E] Test: Regular user does not see Admin link in navigation');
    const regularUser = await createRegularUser(page, context);

    const adminDashboard = new AdminDashboardPage(page);

    // Verify the Admin navigation link is NOT visible
    await adminDashboard.expectAdminMenuNotVisible();

    // Also verify via direct query to be absolutely sure
    const adminLink = page.getByTestId('nav-admin-link');
    const isVisible = await adminLink.isVisible().catch(() => false);

    if (isVisible) {
      throw new Error('Regular user can see Admin link in navigation (should not be visible)');
    }

    console.log('[E2E] ✓ Admin navigation link is not visible to regular user');
  });

  /**
   * Test 5: Unauthenticated user is redirected to login
   *
   * Verifies that when an unauthenticated user attempts to access
   * the admin dashboard, they are redirected to the login page.
   */
  test('unauthenticated user redirected to login', async ({ page, context }) => {
    // Do NOT login - stay unauthenticated
    console.log('[E2E] Test: Unauthenticated user redirected to login');

    // Attempt to navigate to admin dashboard without authentication
    console.log('[E2E] Navigating to /app/admin without authentication...');
    await page.goto('/app/admin');

    // Wait a bit for potential redirect
    await page.waitForLoadState('networkidle');

    // Verify we were redirected to login page
    const currentUrl = page.url();
    const isOnLoginPage = currentUrl.includes('/login') || currentUrl.includes('/auth');

    // Also check for login form elements
    const loginForm = page.getByTestId('login-email-input');
    const isLoginFormVisible = await loginForm.isVisible().catch(() => false);

    if (!isOnLoginPage && !isLoginFormVisible) {
      throw new Error(
        `Unauthenticated user was not redirected to login. Current URL: ${currentUrl}`
      );
    }

    console.log(`[E2E] ✓ Unauthenticated user redirected to login (URL: ${currentUrl})`);
  });

  /**
   * Test 6: Admin user can see navigation link to admin dashboard
   *
   * Verifies that when logged in as an admin, the navigation menu
   * displays an "Admin" link that allows access to the admin dashboard.
   */
  test('admin user sees Admin link in navigation', async ({ page, context }) => {
    // Create and login admin user
    console.log('[E2E] Test: Admin user sees Admin link in navigation');
    const adminUser = await createAdminUser(page, context);

    const adminDashboard = new AdminDashboardPage(page);

    // Navigate to any authenticated page (e.g., /app/groups)
    await page.goto('/app/groups');
    await page.waitForLoadState('networkidle');

    // Verify Admin navigation link is visible
    await adminDashboard.expectAdminMenuVisible();

    // Click the Admin link and verify it navigates to admin dashboard
    const adminLink = page.getByTestId('nav-admin-link');
    await adminLink.click();

    // Wait for navigation and page load
    await page.waitForLoadState('networkidle');

    // Verify we're on the admin dashboard
    const currentUrl = page.url();
    expect(currentUrl).toContain('/app/admin');

    // Verify dashboard elements are visible
    await adminDashboard.waitForLoad();
    await adminDashboard.expectPageVisible();

    console.log('[E2E] ✓ Admin user can see and click Admin navigation link');
  });

  /**
   * Test 7: Admin user can interact with permission management
   *
   * Verifies that an admin user can interact with the permission
   * management features in the admin dashboard.
   */
  test('admin user can interact with permission management', async ({ page, context }) => {
    // Create and login admin user
    console.log('[E2E] Test: Admin user can interact with permission management');
    const adminUser = await createAdminUser(page, context);

    const adminDashboard = new AdminDashboardPage(page);

    // Navigate to admin dashboard
    await adminDashboard.goto();
    await adminDashboard.waitForLoad();

    // Verify dashboard is accessible
    await adminDashboard.expectPageVisible();

    // Verify user search is functional
    await adminDashboard.expectSearchInputVisible();

    // Try searching for a user (search for the admin user themselves)
    await adminDashboard.searchUsers(adminUser.email);

    // Verify table content is still visible after search
    await adminDashboard.expectUserTableVisible();

    // Clear search
    await adminDashboard.clearSearch();

    console.log('[E2E] ✓ Admin user successfully interacted with dashboard');
  });
});
