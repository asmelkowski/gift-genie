name: Deploy to Scaleway

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
  SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
  SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
  # Map Scaleway credentials to AWS env vars for Terraform S3 backend
  AWS_ACCESS_KEY_ID: ${{ secrets.SCW_ACCESS_KEY }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.SCW_SECRET_KEY }}
  AWS_REGION: "fr-par"
  TF_VAR_project_id: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
  TF_VAR_db_iam_application_id: ${{ secrets.DB_IAM_APPLICATION_ID }}
  TF_VAR_db_iam_secret_key: ${{ secrets.DB_IAM_SECRET_KEY }}
  TF_VAR_secret_key: ${{ secrets.SECRET_KEY }}
  TF_VAR_redis_password: ${{ secrets.REDIS_PASSWORD }}
  TF_VAR_region: "fr-par"
  TF_VAR_zone: "fr-par-1"
  TF_VAR_custom_domain: "gift-genie.eu"
  TF_VAR_ovh_zone_name: "gift-genie.eu"
  TF_VAR_ovh_application_key: ${{ secrets.OVH_APPLICATION_KEY }}
  TF_VAR_ovh_application_secret: ${{ secrets.OVH_APPLICATION_SECRET }}
  TF_VAR_ovh_consumer_key: ${{ secrets.OVH_CONSUMER_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set Image Tag
        id: image_tag
        run: |
          SHORT_SHA=$(git rev-parse --short=7 HEAD)
          echo "tag=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "Using image tag: $SHORT_SHA"

      - name: Set up OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0

      - name: Verify Environment Variables
        run: |
          echo "Checking AWS credentials are set..."
          if [ -z "$AWS_ACCESS_KEY_ID" ]; then echo "ERROR: AWS_ACCESS_KEY_ID not set"; exit 1; fi
          if [ -z "$AWS_SECRET_ACCESS_KEY" ]; then echo "ERROR: AWS_SECRET_ACCESS_KEY not set"; exit 1; fi
          if [ -z "$AWS_REGION" ]; then echo "ERROR: AWS_REGION not set"; exit 1; fi
          echo "All required environment variables are set"

      - name: OpenTofu Init
        working-directory: ./infra
        run: tofu init

      - name: Create Registry
        working-directory: ./infra
        run: tofu apply -target=scaleway_registry_namespace.main -auto-approve

      - name: Get Registry Endpoint
        working-directory: ./infra
        id: registry
        run: |
          ENDPOINT=$(tofu output -raw registry_endpoint)
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT

      - name: Login to Scaleway Registry
        run: docker login ${{ steps.registry.outputs.endpoint }} -u nologin -p $SCW_SECRET_KEY

      - name: Build and Push Backend
        run: |
          docker build -t ${{ steps.registry.outputs.endpoint }}/gift-genie-backend:${{ steps.image_tag.outputs.tag }} \
                       -t ${{ steps.registry.outputs.endpoint }}/gift-genie-backend:latest \
                       ./backend
          docker push ${{ steps.registry.outputs.endpoint }}/gift-genie-backend:${{ steps.image_tag.outputs.tag }}
          docker push ${{ steps.registry.outputs.endpoint }}/gift-genie-backend:latest

      - name: Deploy Backend, DB & Redis
        working-directory: ./infra
        env:
          TF_VAR_backend_image_tag: ${{ steps.image_tag.outputs.tag }}
          TF_VAR_frontend_image_tag: ${{ steps.image_tag.outputs.tag }}
        run: tofu apply -target=scaleway_container.backend -target=scaleway_sdb_sql_database.main -target=scaleway_redis_cluster.main -auto-approve

      - name: Get Backend URL
        working-directory: ./infra
        id: backend
        run: |
          URL=$(tofu output -raw backend_url)
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Build and Push Frontend
        run: |
          docker build --build-arg VITE_API_URL=https://api.gift-genie.eu \
                       -t ${{ steps.registry.outputs.endpoint }}/gift-genie-frontend:${{ steps.image_tag.outputs.tag }} \
                       -t ${{ steps.registry.outputs.endpoint }}/gift-genie-frontend:latest \
                       ./frontend
          docker push ${{ steps.registry.outputs.endpoint }}/gift-genie-frontend:${{ steps.image_tag.outputs.tag }}
          docker push ${{ steps.registry.outputs.endpoint }}/gift-genie-frontend:latest

      - name: Full Deploy
        working-directory: ./infra
        env:
          TF_VAR_backend_image_tag: ${{ steps.image_tag.outputs.tag }}
          TF_VAR_frontend_image_tag: ${{ steps.image_tag.outputs.tag }}
        run: tofu apply -auto-approve
