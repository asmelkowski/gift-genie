name: Pull Request

on:
  pull_request:
    branches:
      - main

jobs:
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend development image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          target: development
          tags: gift-genie-backend:dev
          cache-from: type=gha,scope=backend-dev
          cache-to: type=gha,mode=max,scope=backend-dev
          outputs: type=docker,dest=/tmp/backend-dev.tar

      - name: Build backend test image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          target: test
          tags: gift-genie-backend:test
          cache-from: type=gha,scope=backend-test
          cache-to: type=gha,mode=max,scope=backend-test
          outputs: type=docker,dest=/tmp/backend-test.tar

      - name: Build frontend development image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          target: development
          tags: gift-genie-frontend:dev
          cache-from: type=gha,scope=frontend-dev
          cache-to: type=gha,mode=max,scope=frontend-dev
          outputs: type=docker,dest=/tmp/frontend-dev.tar

      - name: Build frontend test image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          target: test
          tags: gift-genie-frontend:test
          cache-from: type=gha,scope=frontend-test
          cache-to: type=gha,mode=max,scope=frontend-test
          outputs: type=docker,dest=/tmp/frontend-test.tar

      - name: Build frontend e2e image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          target: e2e
          tags: gift-genie-frontend:e2e
          cache-from: type=gha,scope=frontend-e2e
          cache-to: type=gha,mode=max,scope=frontend-e2e
          outputs: type=docker,dest=/tmp/frontend-e2e.tar

      - name: Upload backend development image
        uses: actions/upload-artifact@v5
        with:
          name: backend-dev-image
          path: /tmp/backend-dev.tar
          retention-days: 1

      - name: Upload backend test image
        uses: actions/upload-artifact@v5
        with:
          name: backend-test-image
          path: /tmp/backend-test.tar
          retention-days: 1

      - name: Upload frontend development image
        uses: actions/upload-artifact@v5
        with:
          name: frontend-dev-image
          path: /tmp/frontend-dev.tar
          retention-days: 1

      - name: Upload frontend test image
        uses: actions/upload-artifact@v5
        with:
          name: frontend-test-image
          path: /tmp/frontend-test.tar
          retention-days: 1

      - name: Upload frontend e2e image
        uses: actions/upload-artifact@v5
        with:
          name: frontend-e2e-image
          path: /tmp/frontend-e2e.tar
          retention-days: 1

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: build-images

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Download backend development image
        uses: actions/download-artifact@v6
        with:
          name: backend-dev-image
          path: /tmp

      - name: Download frontend development image
        uses: actions/download-artifact@v6
        with:
          name: frontend-dev-image
          path: /tmp

      - name: Download frontend test image
        uses: actions/download-artifact@v6
        with:
          name: frontend-test-image
          path: /tmp

      - name: Load Docker images
        run: |
          docker load --input /tmp/backend-dev.tar
          docker load --input /tmp/frontend-dev.tar

      - name: Lint backend (ruff)
        run: docker run --rm gift-genie-backend:dev ruff check src/

      - name: Type check backend (mypy)
        run: docker run --rm gift-genie-backend:dev mypy src/

      - name: Lint frontend (ESLint)
        run: docker run --rm gift-genie-frontend:dev bun run lint

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [build-images, lint]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: gift_genie_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Download backend development image
        uses: actions/download-artifact@v6
        with:
          name: backend-dev-image
          path: /tmp

      - name: Download backend test image
        uses: actions/download-artifact@v6
        with:
          name: backend-test-image
          path: /tmp

      - name: Load Docker images
        run: |
          docker load --input /tmp/backend-dev.tar
          docker load --input /tmp/backend-test.tar

      - name: Run backend tests with coverage
        run: |
          # Run tests in a named container (will keep running until tests complete)
          docker run --name backend-test-container \
            --network host \
            -e DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/gift_genie_test \
            -e REDIS_URL=redis://localhost:6379 \
            -e SECRET_KEY=test-secret-key-for-ci \
            -e ALGORITHM=HS256 \
            -e ACCESS_TOKEN_EXPIRE_MINUTES=30 \
            gift-genie-backend:test

          # Get the exit code from the container
          EXIT_CODE=$(docker inspect backend-test-container --format='{{.State.ExitCode}}')

          # Copy coverage results from container
          mkdir -p ./backend
          docker cp backend-test-container:/app/coverage.xml \
            ./backend/coverage.xml 2>/dev/null || true

          # Clean up container
          docker rm -f backend-test-container 2>/dev/null || true

          # Exit with the original test exit code
          exit $EXIT_CODE

      - name: Upload backend coverage to artifacts
        uses: actions/upload-artifact@v5
        with:
          name: backend-coverage
          path: backend/coverage.xml

      - name: Download frontend test image
        uses: actions/download-artifact@v6
        with:
          name: frontend-test-image
          path: /tmp

      - name: Load frontend test image
        run: docker load --input /tmp/frontend-test.tar

      - name: Verify frontend test image has test files
        run: |
          echo "ðŸ” Checking test image..."
          docker run --rm gift-genie-frontend:test ls -la /app/src/lib/
          echo "âœ… Test image ready"

      - name: Run frontend unit tests with coverage
        run: |
          # Run tests in a named container (will keep running until tests complete)
          docker run --name frontend-test-container \
            -e CI=true \
            gift-genie-frontend:test

          # Get the exit code from the container
          EXIT_CODE=$(docker inspect frontend-test-container --format='{{.State.ExitCode}}')

          # Copy coverage results from container
          mkdir -p ./frontend/coverage
          docker cp frontend-test-container:/app/coverage/coverage-final.json \
            ./frontend/coverage/coverage-final.json 2>/dev/null || true

          # Clean up container
          docker rm -f frontend-test-container 2>/dev/null || true

          # Exit with the original test exit code
          exit $EXIT_CODE

      - name: Upload frontend coverage to artifacts
        uses: actions/upload-artifact@v5
        with:
          name: frontend-unit-coverage
          path: frontend/coverage/coverage-final.json

  build-frontend-prod:
    name: Build Frontend Production Image
    runs-on: ubuntu-latest
    needs: unit-test

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend production image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          target: production
          tags: gift-genie-frontend:prod
          cache-from: type=gha,scope=frontend-prod
          cache-to: type=gha,mode=max,scope=frontend-prod
          outputs: type=docker,dest=/tmp/frontend-prod.tar

      - name: Upload frontend production image
        uses: actions/upload-artifact@v5
        with:
          name: frontend-prod-image
          path: /tmp/frontend-prod.tar
          retention-days: 1

  build-backend-prod:
    name: Build Backend Production Image
    runs-on: ubuntu-latest
    needs: unit-test

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend production image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          target: production
          tags: gift-genie-backend:prod
          cache-from: type=gha,scope=backend-prod
          cache-to: type=gha,mode=max,scope=backend-prod
          outputs: type=docker,dest=/tmp/backend-prod.tar

      - name: Upload backend production image
        uses: actions/upload-artifact@v5
        with:
          name: backend-prod-image
          path: /tmp/backend-prod.tar
          retention-days: 1

  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build-images, lint, build-frontend-prod, build-backend-prod]

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Download backend production image
        uses: actions/download-artifact@v6
        with:
          name: backend-prod-image
          path: /tmp

      - name: Download frontend development image
        uses: actions/download-artifact@v6
        with:
          name: frontend-dev-image
          path: /tmp

      - name: Load Docker images
        run: |
          docker load --input /tmp/backend-prod.tar
          docker load --input /tmp/frontend-dev.tar

      - name: Create Docker network
        run: docker network create gift-genie-test

      - name: Start PostgreSQL
        run: |
          docker run -d \
            --name postgres \
            --network gift-genie-test \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=gift_genie_test \
            postgres:16

      - name: Start Redis
        run: |
          docker run -d \
            --name redis \
            --network gift-genie-test \
            redis:7-alpine

      - name: Wait for services to be healthy
        run: |
           echo "Waiting for PostgreSQL..."
           for i in {1..30}; do
             docker exec postgres pg_isready -U postgres && break || sleep 1
           done

           echo "Waiting for Redis..."
           for i in {1..30}; do
             docker exec redis redis-cli ping | grep -q PONG && break || sleep 1
           done

      - name: Run database migrations
        run: |
          docker run --rm \
            --network gift-genie-test \
            -e DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/gift_genie_test \
            gift-genie-backend:prod \
            alembic upgrade head

      - name: Start backend server
        run: |
          docker run -d \
            --name backend \
            --network gift-genie-test \
            -p 8000:8000 \
            -e ENV=dev \
            -e DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/gift_genie_test \
            -e REDIS_URL=redis://redis:6379 \
            -e SECRET_KEY=test-secret-key-for-ci \
            -e ALGORITHM=HS256 \
            -e ACCESS_TOKEN_EXPIRE_MINUTES=30 \
            -e CORS_ORIGINS=http://localhost:5173,http://frontend:5173,http://backend:8000 \
            gift-genie-backend:prod

      - name: Wait for backend to be healthy
        run: |
          echo "Waiting for backend..."
          success=0
          for i in {1..60}; do
            if curl -sf http://localhost:8000/health > /dev/null; then
              echo "âœ… Backend is healthy"
              success=1
              break
            fi
            echo "Attempt $i/60: not ready"
            sleep 2
          done
          if [ "$success" -ne 1 ]; then
            echo "âŒ Backend did not become healthy"
            docker logs backend
            exit 1
          fi

      - name: Download frontend e2e image
        uses: actions/download-artifact@v6
        with:
          name: frontend-e2e-image
          path: /tmp

      - name: Load frontend e2e image
        run: docker load --input /tmp/frontend-e2e.tar

      - name: Start frontend dev server
        run: |
          docker run -d \
            --name frontend \
            --network gift-genie-test \
            -p 5173:5173 \
            -e VITE_API_BASE_URL=http://backend:8000 \
            -e HOST=0.0.0.0 \
            gift-genie-frontend:dev

      - name: Wait for frontend to be healthy
        run: |
          echo "Waiting for frontend..."
          for i in {1..60}; do
            if curl -sf http://localhost:5173 | grep -q "root"; then
              echo "âœ… Frontend is ready"
              break
            fi
            echo "Attempt $i/60: not ready"
            sleep 1
          done
          sleep 3  # Brief extra time for hydration

      - name: Verify network connectivity
        run: |
          echo "Testing backend from e2e container..."
          docker run --rm --network gift-genie-test curlimages/curl:latest \
            curl -f http://backend:8000/health

          echo "Testing frontend from e2e container..."
          docker run --rm --network gift-genie-test curlimages/curl:latest \
            curl -f http://frontend:5173

      - name: Create test results directory
        run: mkdir -p test-results

      - name: Run E2E tests
        timeout-minutes: 8
        run: |
          echo "ðŸš€ Running E2E tests..."
          docker run --name e2e-tests \
            --network gift-genie-test \
            -e CI=true \
            -v $(pwd)/test-results:/app/test-results \
            gift-genie-frontend:e2e \
            npx playwright test

          EXIT_CODE=$(docker inspect e2e-tests --format='{{.State.ExitCode}}')

          # Copy any additional artifacts
          docker cp e2e-tests:/app/playwright-report ./test-results/ 2>/dev/null || true

          docker rm -f e2e-tests 2>/dev/null || true
          exit $EXIT_CODE

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report
          path: test-results/
          retention-days: 7

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          echo "Collecting diagnostics..."
          docker logs backend > test-results/backend-logs.txt 2>&1 || true
          docker logs frontend > test-results/frontend-logs.txt 2>&1 || true
          docker logs postgres > test-results/postgres-logs.txt 2>&1 || true
          docker logs redis > test-results/redis-logs.txt 2>&1 || true

      - name: Upload diagnostics
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-diagnostics
          path: test-results/
          retention-days: 7

      - name: Cleanup containers
        if: always()
        run: |
          docker stop backend frontend postgres redis || true
          docker rm backend frontend postgres redis || true
          docker network rm gift-genie-test || true

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infra

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Check for changes in infra
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            infra:
              - 'infra/**'

      - name: Setup OpenTofu
        if: steps.changes.outputs.infra == 'true'
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.6.0

      - name: OpenTofu Init
        if: steps.changes.outputs.infra == 'true'
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          AWS_ACCESS_KEY_ID: ${{ secrets.SCW_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SCW_SECRET_KEY }}
          AWS_REGION: "pl-waw"
        run: tofu init

      - name: OpenTofu Validate
        if: steps.changes.outputs.infra == 'true'
        run: tofu validate

      - name: OpenTofu Plan
        if: steps.changes.outputs.infra == 'true'
        env:
          SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          AWS_ACCESS_KEY_ID: ${{ secrets.SCW_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SCW_SECRET_KEY }}
          AWS_REGION: "pl-waw"
          TF_VAR_project_id: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
          TF_VAR_db_password: ${{ secrets.DATABASE_PASSWORD }}
        run: tofu plan -input=false



  status-comment:
    name: Status Comment
    runs-on: ubuntu-latest
    needs: [lint, unit-test, e2e-test, terraform-plan]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Check job statuses
        id: check_status
        run: |
          if [[ "${{ needs.lint.result }}" == "success" && "${{ needs.unit-test.result }}" == "success" && "${{ needs.e2e-test.result }}" == "success" && ("${{ needs.terraform-plan.result }}" == "success" || "${{ needs.terraform-plan.result }}" == "skipped") ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… All checks passed successfully!" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Some checks failed. Please review the details below:" >> $GITHUB_OUTPUT
          fi

      - name: Download backend coverage
        if: needs.unit-test.result == 'success'
        uses: actions/download-artifact@v6
        with:
          name: backend-coverage
        continue-on-error: true

      - name: Download frontend unit coverage
        if: needs.unit-test.result == 'success'
        uses: actions/download-artifact@v6
        with:
          name: frontend-unit-coverage
        continue-on-error: true

      - name: Comment PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const lintStatus = '${{ needs.lint.result }}';
            const unitTestStatus = '${{ needs.unit-test.result }}';
            const e2eTestStatus = '${{ needs.e2e-test.result }}';
            const terraformStatus = '${{ needs.terraform-plan.result }}';
            const overallStatus = '${{ steps.check_status.outputs.status }}';
            const message = '${{ steps.check_status.outputs.message }}';

            const statusEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'ðŸš«';
                case 'skipped': return 'â­ï¸';
                default: return 'â“';
              }
            };

            const body = `## ${message}

            ### Job Results
            | Job | Status |
            |-----|--------|
            | Lint | ${statusEmoji(lintStatus)} ${lintStatus} |
            | Unit Tests | ${statusEmoji(unitTestStatus)} ${unitTestStatus} |
            | E2E Tests | ${statusEmoji(e2eTestStatus)} ${e2eTestStatus} |
            | Terraform Plan | ${statusEmoji(terraformStatus)} ${terraformStatus} |

            ### Details
            - **Workflow Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Commit**: ${{ github.event.pull_request.head.sha }}
            - **Branch**: ${{ github.head_ref }}

            ${overallStatus === 'success' ? 'ðŸŽ‰ This PR is ready for review!' : 'âš ï¸ Please fix the failing checks before merging.'}
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Job Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
