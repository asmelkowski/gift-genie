name: Pull Request

on:
  pull_request:
    branches:
      - main

jobs:
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend development image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          target: development
          tags: gift-genie-backend:dev
          cache-from: type=gha,scope=backend-dev
          cache-to: type=gha,mode=max,scope=backend-dev
          outputs: type=docker,dest=/tmp/backend-dev.tar

      - name: Build backend test image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          target: test
          tags: gift-genie-backend:test
          cache-from: type=gha,scope=backend-test
          cache-to: type=gha,mode=max,scope=backend-test
          outputs: type=docker,dest=/tmp/backend-test.tar

      - name: Build frontend development image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          target: development
          tags: gift-genie-frontend:dev
          cache-from: type=gha,scope=frontend-dev
          cache-to: type=gha,mode=max,scope=frontend-dev
          outputs: type=docker,dest=/tmp/frontend-dev.tar

      - name: Build frontend test image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          target: test
          tags: gift-genie-frontend:test
          cache-from: type=gha,scope=frontend-test
          cache-to: type=gha,mode=max,scope=frontend-test
          outputs: type=docker,dest=/tmp/frontend-test.tar

      - name: Build frontend e2e image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          target: e2e
          tags: gift-genie-frontend:e2e
          cache-from: type=gha,scope=frontend-e2e
          cache-to: type=gha,mode=max,scope=frontend-e2e
          outputs: type=docker,dest=/tmp/frontend-e2e.tar

      - name: Upload backend development image
        uses: actions/upload-artifact@v5
        with:
          name: backend-dev-image
          path: /tmp/backend-dev.tar
          retention-days: 1

      - name: Upload backend test image
        uses: actions/upload-artifact@v5
        with:
          name: backend-test-image
          path: /tmp/backend-test.tar
          retention-days: 1

      - name: Upload frontend development image
        uses: actions/upload-artifact@v5
        with:
          name: frontend-dev-image
          path: /tmp/frontend-dev.tar
          retention-days: 1

      - name: Upload frontend test image
        uses: actions/upload-artifact@v5
        with:
          name: frontend-test-image
          path: /tmp/frontend-test.tar
          retention-days: 1

      - name: Upload frontend e2e image
        uses: actions/upload-artifact@v5
        with:
          name: frontend-e2e-image
          path: /tmp/frontend-e2e.tar
          retention-days: 1

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: build-images

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Download backend development image
        uses: actions/download-artifact@v6
        with:
          name: backend-dev-image
          path: /tmp

      - name: Download frontend development image
        uses: actions/download-artifact@v6
        with:
          name: frontend-dev-image
          path: /tmp

      - name: Download frontend test image
        uses: actions/download-artifact@v6
        with:
          name: frontend-test-image
          path: /tmp

      - name: Load Docker images
        run: |
          docker load --input /tmp/backend-dev.tar
          docker load --input /tmp/frontend-dev.tar

      - name: Lint backend (ruff)
        run: docker run --rm gift-genie-backend:dev ruff check src/

      - name: Type check backend (mypy)
        run: docker run --rm gift-genie-backend:dev mypy src/

      - name: Lint frontend (ESLint)
        run: docker run --rm gift-genie-frontend:dev bun run lint

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [build-images, lint]

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: gift_genie_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Download backend development image
        uses: actions/download-artifact@v6
        with:
          name: backend-dev-image
          path: /tmp

      - name: Download backend test image
        uses: actions/download-artifact@v6
        with:
          name: backend-test-image
          path: /tmp

      - name: Load Docker images
        run: |
          docker load --input /tmp/backend-dev.tar
          docker load --input /tmp/backend-test.tar

      - name: Run backend tests with coverage
        run: |
          # Run tests in a named container (will keep running until tests complete)
          docker run --name backend-test-container \
            --network host \
            -e DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/gift_genie_test \
            -e REDIS_URL=redis://localhost:6379 \
            -e SECRET_KEY=test-secret-key-for-ci \
            -e ALGORITHM=HS256 \
            -e ACCESS_TOKEN_EXPIRE_MINUTES=30 \
            gift-genie-backend:test

          # Get the exit code from the container
          EXIT_CODE=$(docker inspect backend-test-container --format='{{.State.ExitCode}}')

          # Copy coverage results from container
          mkdir -p ./backend
          docker cp backend-test-container:/app/coverage.xml \
            ./backend/coverage.xml 2>/dev/null || true

          # Clean up container
          docker rm -f backend-test-container 2>/dev/null || true

          # Exit with the original test exit code
          exit $EXIT_CODE

      - name: Upload backend coverage to artifacts
        uses: actions/upload-artifact@v5
        with:
          name: backend-coverage
          path: backend/coverage.xml

      - name: Download frontend test image
        uses: actions/download-artifact@v6
        with:
          name: frontend-test-image
          path: /tmp

      - name: Load frontend test image
        run: docker load --input /tmp/frontend-test.tar

      - name: Verify frontend test image has test files
        run: |
          echo "ðŸ” Checking test image..."
          docker run --rm gift-genie-frontend:test ls -la /app/src/lib/
          echo "âœ… Test image ready"

      - name: Run frontend unit tests with coverage
        run: |
          # Run tests in a named container (will keep running until tests complete)
          docker run --name frontend-test-container \
            -e CI=true \
            gift-genie-frontend:test

          # Get the exit code from the container
          EXIT_CODE=$(docker inspect frontend-test-container --format='{{.State.ExitCode}}')

          # Copy coverage results from container
          mkdir -p ./frontend/coverage
          docker cp frontend-test-container:/app/coverage/coverage-final.json \
            ./frontend/coverage/coverage-final.json 2>/dev/null || true

          # Clean up container
          docker rm -f frontend-test-container 2>/dev/null || true

          # Exit with the original test exit code
          exit $EXIT_CODE

      - name: Upload frontend coverage to artifacts
        uses: actions/upload-artifact@v5
        with:
          name: frontend-unit-coverage
          path: frontend/coverage/coverage-final.json

  build-frontend-prod:
    name: Build Frontend Production Image
    runs-on: ubuntu-latest
    needs: unit-test

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend production image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          target: production
          tags: gift-genie-frontend:prod
          cache-from: type=gha,scope=frontend-prod
          cache-to: type=gha,mode=max,scope=frontend-prod
          outputs: type=docker,dest=/tmp/frontend-prod.tar

      - name: Upload frontend production image
        uses: actions/upload-artifact@v5
        with:
          name: frontend-prod-image
          path: /tmp/frontend-prod.tar
          retention-days: 1

  build-backend-prod:
    name: Build Backend Production Image
    runs-on: ubuntu-latest
    needs: unit-test

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend production image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          target: production
          tags: gift-genie-backend:prod
          cache-from: type=gha,scope=backend-prod
          cache-to: type=gha,mode=max,scope=backend-prod
          outputs: type=docker,dest=/tmp/backend-prod.tar

      - name: Upload backend production image
        uses: actions/upload-artifact@v5
        with:
          name: backend-prod-image
          path: /tmp/backend-prod.tar
          retention-days: 1

  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build-images, lint, build-frontend-prod, build-backend-prod]

    steps:
      - name: Check out repository
        uses: actions/checkout@v5

      - name: Download backend production image
        uses: actions/download-artifact@v6
        with:
          name: backend-prod-image
          path: /tmp

      - name: Download frontend development image
        uses: actions/download-artifact@v6
        with:
          name: frontend-dev-image
          path: /tmp

      - name: Load Docker images
        run: |
          docker load --input /tmp/backend-prod.tar
          docker load --input /tmp/frontend-dev.tar

      - name: Create Docker network
        run: docker network create gift-genie-test

      - name: Start PostgreSQL
        run: |
          docker run -d \
            --name postgres \
            --network gift-genie-test \
            -e POSTGRES_USER=postgres \
            -e POSTGRES_PASSWORD=postgres \
            -e POSTGRES_DB=gift_genie_test \
            postgres:16

      - name: Start Redis
        run: |
          docker run -d \
            --name redis \
            --network gift-genie-test \
            redis:7-alpine

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for PostgreSQL..."
          for i in {1..30}; do
            docker exec postgres pg_isready -U postgres && break || sleep 1
          done

          echo "Waiting for Redis..."
          for i in {1..30}; do
            docker exec redis redis-cli ping | grep -q PONG && break || sleep 1
          done

      - name: Run database migrations
        run: |
          docker run --rm \
            --network gift-genie-test \
            -e DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/gift_genie_test \
            gift-genie-backend:prod \
            alembic upgrade head

      - name: Start backend server
        run: |
          docker run -d \
            --name backend \
            --network gift-genie-test \
            -p 8000:8000 \
            -e DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/gift_genie_test \
            -e REDIS_URL=redis://redis:6379 \
            -e SECRET_KEY=test-secret-key-for-ci \
            -e ALGORITHM=HS256 \
            -e ACCESS_TOKEN_EXPIRE_MINUTES=30 \
            -e CORS_ORIGINS=http://localhost:5173,http://frontend:5173,http://backend:8000 \
            -e COOKIE_SAMESITE=none \
            -e COOKIE_SECURE=false \
            gift-genie-backend:prod

      - name: Wait for backend to be healthy
        run: |
          echo "Waiting for backend..."
          success=0
          for i in {1..60}; do
            if curl -sf http://localhost:8000/health > /dev/null; then
              echo "âœ… Backend is healthy"
              success=1
              break
            fi
            status=$(docker inspect backend --format='{{.State.Status}} (exit={{.State.ExitCode}})' 2>/dev/null || echo 'unknown')
            echo "Attempt $i/60: not ready (status=$status)"
            sleep 2
          done
          if [ "$success" -ne 1 ]; then
            echo "âŒ Backend did not become healthy in time"
            echo "--- docker ps -a ---"
            docker ps -a || true
            echo "--- docker inspect backend ---"
            docker inspect backend || true
            echo "--- docker logs backend ---"
            docker logs backend || true
            exit 1
          fi

      - name: Collect backend logs (on failure)
        if: failure()
        run: |
          docker logs backend > backend-logs.txt 2>&1 || true
          docker inspect backend > backend-inspect.json 2>&1 || true

      - name: Upload backend logs
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: backend-diagnostics
          path: |
            backend-logs.txt
            backend-inspect.json
          retention-days: 7

      - name: Download frontend e2e image
        uses: actions/download-artifact@v6
        with:
          name: frontend-e2e-image
          path: /tmp

      - name: Load frontend e2e image
        run: docker load --input /tmp/frontend-e2e.tar

      - name: Start frontend dev server
        run: |
           docker run -d \
             --name frontend \
             --network gift-genie-test \
             -p 5173:5173 \
              -e VITE_API_BASE_URL=http://backend:8000 \
              -e HOST=0.0.0.0 \
              -e VITE_HOST=0.0.0.0 \
              gift-genie-frontend:dev

      - name: Wait for frontend to be healthy
        run: |
          echo "Waiting for frontend to be fully loaded..."
          for i in {1..60}; do
            if curl -sf http://localhost:5173 | grep -q "root"; then
              echo "âœ… Frontend is ready"
              break
            fi
            echo "Attempt $i/60: Frontend not ready yet..."
            sleep 1
          done

          # Give frontend a bit more time to fully hydrate
          echo "Allowing frontend to fully hydrate..."
          sleep 5

      - name: Verify E2E network connectivity
        run: |
          echo "ðŸ” Testing network connectivity from E2E container perspective..."

          # Test backend connectivity
          echo "Testing backend at http://backend:8000/health..."
          docker run --rm --network gift-genie-test curlimages/curl:latest \
            curl -v --max-time 10 http://backend:8000/health

          # Test frontend connectivity
          echo "Testing frontend at http://frontend:5173..."
          docker run --rm --network gift-genie-test curlimages/curl:latest \
            curl -v --max-time 10 http://frontend:5173

          # Test API endpoint that frontend will use
          echo "Testing API endpoint at http://backend:8000/api/v1/health..."
          docker run --rm --network gift-genie-test curlimages/curl:latest \
            curl -v --max-time 10 http://backend:8000/api/v1/health

          # Test connectivity from frontend container perspective
          echo "Testing backend connectivity from frontend container..."
           docker exec frontend curl -v --max-time 10 http://backend:8000/health || echo "Frontend container cannot reach backend"

           echo "âœ… Network connectivity verified"

      - name: Verify E2E image and dependencies
        run: |
          echo "ðŸ” Checking e2e image..."
          docker run --rm gift-genie-frontend:e2e ls -la /app/playwright.config.ts
          echo "âœ… Config found"

          docker run --rm gift-genie-frontend:e2e ls -la /app/e2e/
          echo "âœ… E2E tests found"

          docker run --rm gift-genie-frontend:e2e which bunx
           echo "âœ… Bun found"

      - name: Create Playwright directories
        run: |
          mkdir -p playwright/.auth
          mkdir -p playwright/screenshots
          mkdir -p playwright/screenshots/test-results
          mkdir -p test-results/screenshots
          echo "âœ… Playwright directories created"

      - name: Run E2E tests
        timeout-minutes: 8
        run: |
           # Create test results directory
           mkdir -p test-results

           # Ensure playwright directories exist with proper permissions
           echo "ðŸ”§ Setting up Playwright directories..."
           mkdir -p playwright/.auth
           mkdir -p playwright/screenshots
           chmod -R 755 playwright/
           ls -la playwright/

           # Verify volume mounts will work
           echo "ðŸ” Pre-run directory verification..."
           echo "Host playwright directory:"
           ls -la $(pwd)/playwright/ || echo "Host playwright directory not accessible"
           echo "Host test-results directory:"
           ls -la $(pwd)/test-results/ || echo "Host test-results directory not accessible"

           # Run E2E tests with parallel execution
           echo "ðŸš€ Starting E2E tests (Parallel Execution Mode)..."
           docker run --name e2e-tests \
             --network gift-genie-test \
             -e CI=true \
             -e VITE_API_BASE_URL=http://backend:8000 \
             -v $(pwd)/test-results:/app/test-results \
             -v $(pwd)/playwright:/app/playwright \
             gift-genie-frontend:e2e \
             sh -c "
               echo 'ðŸ“ Container directory verification...' &&
               ls -la /app/playwright/ &&
               echo 'ðŸƒ Running Playwright tests in parallel (4 workers)...' &&
               npx playwright test --workers=4 &&
               echo 'âœ… Parallel test execution completed'
             "

           # Get exit code from container
           EXIT_CODE=$(docker inspect e2e-tests --format='{{.State.ExitCode}}')

           # Verify auth state was created and persisted
           echo "ðŸ” Verifying auth state persistence on host..."
           if [ -f "$(pwd)/playwright/.auth/user.json" ]; then
             echo "âœ… Auth state persisted to host:"
             ls -la $(pwd)/playwright/.auth/user.json
             head -c 200 $(pwd)/playwright/.auth/user.json
           else
             echo "âŒ Auth state NOT persisted to host"
             EXIT_CODE=1
           fi

           # Copy test results from container (in case volume mount had issues)
           docker cp e2e-tests:/app/playwright-report ./test-results/ 2>/dev/null || true
           docker cp e2e-tests:/app/playwright ./playwright-results 2>/dev/null || true
           docker cp e2e-tests:/app/coverage ./test-results/ 2>/dev/null || true
           docker cp e2e-tests:/app/test-results ./test-results/container-results 2>/dev/null || true

           # Copy screenshots from all possible locations
           echo "ðŸ“¸ Collecting screenshots from container..."
           docker cp e2e-tests:/app/playwright-report ./test-results/playwright-report-copy 2>/dev/null || true
           docker cp e2e-tests:/app/playwright/screenshots ./test-results/screenshots-from-container 2>/dev/null || true
           docker cp e2e-tests:/app/test-results/screenshots ./test-results/screenshots-from-test-results 2>/dev/null || true

           # Copy any screenshots from playwright root directory
           docker cp e2e-tests:/app/playwright/*.png ./test-results/screenshots/ 2>/dev/null || true

           # Clean up container
           docker rm -f e2e-tests 2>/dev/null || true

           # Exit with the original test exit code
           exit $EXIT_CODE

      - name: Upload E2E screenshots
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-screenshots
          path: |
            test-results/screenshots/
            test-results/playwright-report-copy/
            test-results/screenshots-from-container/
            test-results/screenshots-from-test-results/
            playwright-results/screenshots/
            playwright/*.png
          retention-days: 14
          if-no-files-found: warn

      - name: Collect E2E diagnostics (on failure)
        if: failure()
        run: |
          echo "ðŸ” Collecting E2E diagnostics..."

          # Collect container logs
          docker logs frontend > test-results/frontend-logs.txt 2>&1 || true
          docker logs e2e-tests > test-results/e2e-tests-logs.txt 2>&1 || true
          docker logs backend > test-results/backend-logs.txt 2>&1 || true
          docker logs postgres > test-results/postgres-logs.txt 2>&1 || true
          docker logs redis > test-results/redis-logs.txt 2>&1 || true

          # Collect container inspection
          docker inspect frontend > test-results/frontend-inspect.json 2>&1 || true
          docker inspect backend > test-results/backend-inspect.json 2>&1 || true

          # Explicitly collect screenshots for diagnostics
          echo "ðŸ“¸ Collecting screenshots for diagnostics..."
          mkdir -p test-results/diagnostics-screenshots

          # Copy screenshots from all possible locations to diagnostics
          cp -r test-results/screenshots/* test-results/diagnostics-screenshots/ 2>/dev/null || true
          cp -r test-results/playwright-report-copy/* test-results/diagnostics-screenshots/ 2>/dev/null || true
          cp -r test-results/screenshots-from-container/* test-results/diagnostics-screenshots/ 2>/dev/null || true
          cp -r test-results/screenshots-from-test-results/* test-results/diagnostics-screenshots/ 2>/dev/null || true
          cp -r playwright-results/screenshots/* test-results/diagnostics-screenshots/ 2>/dev/null || true
          cp playwright/*.png test-results/diagnostics-screenshots/ 2>/dev/null || true

          # Create screenshot inventory
          echo "ðŸ“‹ Screenshot inventory:" > test-results/screenshot-inventory.txt
          find test-results/diagnostics-screenshots -name "*.png" -type f 2>/dev/null | while read file; do
            echo "Found screenshot: $file" >> test-results/screenshot-inventory.txt
            ls -la "$file" >> test-results/screenshot-inventory.txt
          done

          # Test network connectivity
          echo "Testing network connectivity..." > test-results/network-test.txt
          docker run --rm --network gift-genie-test curl -s -o /dev/null -w "%{http_code}" http://backend:8000/health >> test-results/network-test.txt 2>/dev/null || echo "Backend unreachable" >> test-results/network-test.txt
          docker run --rm --network gift-genie-test curl -s -o /dev/null -w "%{http_code}" http://frontend:5173 >> test-results/network-test.txt 2>/dev/null || echo "Frontend unreachable" >> test-results/network-test.txt

          # List all containers and networks
          docker ps -a > test-results/docker-ps.txt 2>&1 || true
          docker network ls > test-results/docker-networks.txt 2>/dev/null || true

          echo "âœ… Diagnostics collected"

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-report
          path: |
            test-results/playwright-report/
            test-results/junit.xml
          retention-days: 7

      - name: Upload E2E coverage to artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: frontend-e2e-coverage
          path: test-results/coverage/
          retention-days: 7

      - name: Upload E2E diagnostics
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: e2e-diagnostics
          path: |
            test-results/
            !test-results/playwright-report/
            !test-results/coverage/
          retention-days: 7

      - name: Cleanup containers
        if: always()
        run: |
          docker stop backend frontend postgres redis || true
          docker rm backend frontend postgres redis || true
          docker network rm gift-genie-test || true

  status-comment:
    name: Status Comment
    runs-on: ubuntu-latest
    needs: [lint, unit-test, e2e-test]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Check job statuses
        id: check_status
        run: |
          if [[ "${{ needs.lint.result }}" == "success" && "${{ needs.unit-test.result }}" == "success" && "${{ needs.e2e-test.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=âœ… All checks passed successfully!" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=âŒ Some checks failed. Please review the details below:" >> $GITHUB_OUTPUT
          fi

      - name: Download backend coverage
        if: needs.unit-test.result == 'success'
        uses: actions/download-artifact@v6
        with:
          name: backend-coverage
        continue-on-error: true

      - name: Download frontend unit coverage
        if: needs.unit-test.result == 'success'
        uses: actions/download-artifact@v6
        with:
          name: frontend-unit-coverage
        continue-on-error: true

      - name: Comment PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const lintStatus = '${{ needs.lint.result }}';
            const unitTestStatus = '${{ needs.unit-test.result }}';
            const e2eTestStatus = '${{ needs.e2e-test.result }}';
            const overallStatus = '${{ steps.check_status.outputs.status }}';
            const message = '${{ steps.check_status.outputs.message }}';

            const statusEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'ðŸš«';
                case 'skipped': return 'â­ï¸';
                default: return 'â“';
              }
            };

            const body = `## ${message}

            ### Job Results
            | Job | Status |
            |-----|--------|
            | Lint | ${statusEmoji(lintStatus)} ${lintStatus} |
            | Unit Tests | ${statusEmoji(unitTestStatus)} ${unitTestStatus} |
            | E2E Tests | ${statusEmoji(e2eTestStatus)} ${e2eTestStatus} |

            ### Details
            - **Workflow Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Commit**: ${{ github.event.pull_request.head.sha }}
            - **Branch**: ${{ github.head_ref }}

            ${overallStatus === 'success' ? 'ðŸŽ‰ This PR is ready for review!' : 'âš ï¸ Please fix the failing checks before merging.'}
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Job Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
